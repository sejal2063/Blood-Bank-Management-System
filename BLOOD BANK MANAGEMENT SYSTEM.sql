create database BLOODBANKSYSTEM;
use BLOODBANKSYSTEM;
-- BLOODBANK TABLE
CREATE TABLE BLOODBANK (
  BBID   CHAR(5),
  BNAME  VARCHAR(20) NOT NULL,
  BBCON  CHAR(10) NOT NULL,
  BBADD  VARCHAR(30) NOT NULL,
  CONSTRAINT BBPK  PRIMARY KEY (BBID),
  CONSTRAINT BBU   UNIQUE (BBCON),
  CONSTRAINT BBCK  CHECK (BBCON LIKE '9%' OR BBCON LIKE '8%' OR BBCON LIKE '7%' OR BBCON LIKE '6%')
);
DESC BLOODBANK;
insert into BLOODBANK values('BB1', 'SANKETBB',9049393958,'PUNE');
insert into BLOODBANK values('BB2', 'GEETABB',9543219876,'PUNE');
insert into BLOODBANK values('BB3', 'PRADSADBB',7345219876,'PUNE');
insert into BLOODBANK values('BB4', 'PRIYANKABB',8435129876,'PUNE');
select * from BLOODBANK;
DELETE FROM BLOODBANK
WHERE BBID = 'BB2';

-- PATIENT TABLE
CREATE TABLE PATIENT (
  PID   CHAR(5),
  PNAME VARCHAR(20) NOT NULL,
  PBG   VARCHAR(6)  NOT NULL,
  PGEN  VARCHAR(6)  NOT NULL,
  PAGE  CHAR(3),
  PCON  CHAR(10) NOT NULL,
  BBID  CHAR(5),
  
  CONSTRAINT PPK PRIMARY KEY (PID),
  CONSTRAINT PCK CHECK (
    PCON LIKE '9%' 
    OR PCON LIKE '8%' 
    OR PCON LIKE '7%' 
    OR PCON LIKE '6%'
  ),
  CONSTRAINT PFK FOREIGN KEY (BBID) REFERENCES BLOODBANK (BBID)
);

INSERT INTO PATIENT VALUES ('P1', 'AYAN', 'A+', 'M', '31', '6547839212', 'BB1');
INSERT INTO PATIENT VALUES ('P2', 'RIDHHI', 'O+', 'F', '24', '7547893212', 'BB3');
INSERT INTO PATIENT VALUES ('P3', 'SIDHHI', 'AB+', 'F', '23', '7546892312', 'BB1');
INSERT INTO PATIENT VALUES ('P4', 'PRITI', 'B+', 'F', '32', '9546812312', 'BB4');
INSERT INTO PATIENT VALUES ('P5', 'PAYAL', 'B+', 'F', '27', '8246812312', 'BB2');
INSERT INTO PATIENT VALUES ('P6', 'AMAR', 'O+', 'M', '18', '8246802312', 'BB2');
INSERT INTO PATIENT VALUES ('P7', 'VIDHI', 'O-', 'F', '42', '624683284', 'BB4');
INSERT INTO PATIENT VALUES ('P8', 'NIDHI', 'AB+', 'F', '31', '6246808284', 'BB2');
INSERT INTO PATIENT VALUES ('P9', 'PRACHI', 'A+', 'F', '34', '7246802284', 'BB3');
INSERT INTO PATIENT VALUES ('P10', 'ARAV', 'O-', 'M', '37', '6742082284', 'BB1');

select * from PATIENT;

-- DONAR TABLE

CREATE TABLE DONAR(
DID CHAR(5) PRIMARY KEY,
DNAME VARCHAR(20) NOT NULL,
DBG VARCHAR(6) NOT NULL,
DGEN VARCHAR(6) NOT NULL,
DCON CHAR(10) NOT NULL CHECK (DCON LIKE '9%' OR DCON LIKE '8%' OR DCON LIKE '7%' OR DCON LIKE '6%'),
DON_DATE VARCHAR(20) NOT NULL,
MED_REPO VARCHAR(20) NOT NULL,
BBID CHAR(5),
FOREIGN KEY (BBID) REFERENCES BLOODBANK (BBID) 
);

INSERT INTO DONAR (DID, DNAME, DBG, DGEN, DCON, DON_DATE, MED_REPO, BBID) VALUES ('D1', 'PRAKRITI', 'O+', 'F', '9876543252', '12 DEC 2023', 'NS', 'BB3');
INSERT INTO DONAR (DID, DNAME, DBG, DGEN, DCON, DON_DATE, MED_REPO, BBID) VALUES ('D2', 'PANKAJ', 'B+', 'M', '9874433252', '7 AUG 2023', 'S', 'BB4');
INSERT INTO DONAR (DID, DNAME, DBG, DGEN, DCON, DON_DATE, MED_REPO, BBID) VALUES ('D3', 'PRIYA', 'O+', 'F', '8274433252', '14 JAN 2024', 'S', 'BB2');
INSERT INTO DONAR (DID, DNAME, DBG, DGEN, DCON, DON_DATE, MED_REPO, BBID) VALUES ('D4', 'VISHAKHA', 'B+', 'F', '6474433252', '26 MAR 2023', 'S', 'BB1');
INSERT INTO DONAR (DID, DNAME, DBG, DGEN, DCON, DON_DATE, MED_REPO, BBID) VALUES ('D5', 'DHIRAJ', 'AB+', 'H', '6474422325', '5 SEP 2023', 'S', 'BB1');
INSERT INTO DONAR (DID, DNAME, DBG, DGEN, DCON, DON_DATE, MED_REPO, BBID) VALUES ('D6', 'SUHANI', 'A+', 'F', '7274432325', '3 FEB 2024', 'NS', 'BB3');
INSERT INTO DONAR (DID, DNAME, DBG, DGEN, DCON, DON_DATE, MED_REPO, BBID) VALUES ('D7', 'ARYAN', 'O-', 'M', '8764422325', '13 MAY 2023', 'S', 'BB4');
INSERT INTO DONAR (DID, DNAME, DBG, DGEN, DCON, DON_DATE, MED_REPO, BBID) VALUES ('D8', 'AGSTYA', 'B-', 'M', '7864422325', '7 AUG 2023', 'S', 'BB4');
INSERT INTO DONAR (DID, DNAME, DBG, DGEN, DCON, DON_DATE, MED_REPO, BBID) VALUES ('D9', 'SAUI', 'AB+', 'F', '7764223513', '14 SEP 2023', 'S', 'BB2');
INSERT INTO DONAR (DID, DNAME, DBG, DGEN, DCON, DON_DATE, MED_REPO, BBID) VALUES ('D10', 'SAMARTH', 'A+', 'M', '776433513', '9 FEB 2024', 'S', 'BB1');
INSERT INTO DONAR (DID, DNAME, DBG, DGEN, DCON, DON_DATE, MED_REPO, BBID) VALUES ('D11', 'NISHANT', 'A+', 'M', '7666444333', '12 DEC 2023', 'S', 'BB3');
INSERT INTO DONAR (DID, DNAME, DBG, DGEN, DCON, DON_DATE, MED_REPO, BBID) VALUES ('D12', 'AHIT', 'A+', 'M', '7666456333', '13 MAY 2023', 'S', 'BB4');
INSERT INTO DONAR (DID, DNAME, DBG, DGEN, DCON, DON_DATE, MED_REPO, BBID) VALUES ('D13', 'AKSHAY', 'A+', 'M', '6766456333', '6 JAN 2024', 'S', 'BB3');
INSERT INTO DONAR (DID, DNAME, DBG, DGEN, DCON, DON_DATE, MED_REPO, BBID) VALUES ('D14', 'ABHAY', 'O+', 'M', '6777756333', '19 JAN 2024', 'S', 'BB2');
INSERT INTO DONAR (DID, DNAME, DBG, DGEN, DCON, DON_DATE, MED_REPO, BBID) VALUES ('D15', 'PRADIP', 'O+', 'M', '6777753333', '6 AUG 2023', 'S', 'BB1');

select * from DONAR;

-- HOSPITAL TABLE
CREATE TABLE HOSPITAL(
HID CHAR(5),
HNAME VARCHAR(20) NOT NULL,
HCON CHAR(10) NOT NULL,
PID CHAR(5) NOT NULL,
BBID CHAR(5) NOT NULL,
CONSTRAINT HPK PRIMARY KEY (HID),
CONSTRAINT HCK CHECK (HCON LIKE '9%' OR HCON LIKE '8%' OR HCON LIKE '7%' OR HCON LIKE '6%'),
CONSTRAINT HFK1 FOREIGN KEY (PID) REFERENCES PATIENT(PID),
CONSTRAINT HFK2 FOREIGN KEY (BBID) REFERENCES BLOODBANK(BBID) 
);

INSERT INTO HOSPITAL (HID, HNAME, HCON, PID, BBID) VALUES ('H1', 'SUPER', '6748329174', 'P4', 'BB4');
INSERT INTO HOSPITAL (HID, HNAME, HCON, PID, BBID) VALUES ('H2', 'BHAVANI', '6748325674', 'P5', 'BB1');
INSERT INTO HOSPITAL (HID, HNAME, HCON, PID, BBID) VALUES ('H3', 'FORTIS', '7648325674', 'P3', 'BB2');
INSERT INTO HOSPITAL (HID, HNAME, HCON, PID, BBID) VALUES ('H4', 'NARAYAN', '7648345576', 'P2', 'BB4');
INSERT INTO HOSPITAL (HID, HNAME, HCON, PID, BBID) VALUES ('H5', 'AMRITA', '7644444476', 'P4', 'BB3');
INSERT INTO HOSPITAL (HID, HNAME, HCON, PID, BBID) VALUES ('H6', 'KRITIKA', '6744344762', 'P4', 'BB3');
INSERT INTO HOSPITAL (HID, HNAME, HCON, PID, BBID) VALUES ('H7', 'PRAYER', '6744344267', 'P5', 'BB4');
INSERT INTO HOSPITAL (HID, HNAME, HCON, PID, BBID) VALUES ('H8', 'VINAYAK', '6744334252', 'P2', 'BB2');
INSERT INTO HOSPITAL (HID, HNAME, HCON, PID, BBID) VALUES ('H9', 'ASTER', '9824244252', 'P1', 'BB2');
INSERT INTO HOSPITAL (HID, HNAME, HCON, PID, BBID) VALUES ('H10', 'SPECT', '9824244444', 'P4', 'BB4');

select * from HOSPITAL;

-- BLOOD_AVAILABILITY TABLE
CREATE TABLE BLOOD_AVAILABILITY(
BBID CHAR(5) NOT NULL,
BG CHAR(5) NOT NULL,
QUANTITY CHAR(3) NOT NULL 
);

INSERT INTO BLOOD_AVAILABILITY (BBID, BG, QUANTITY) VALUES ('BB1', 'O+', '20');
INSERT INTO BLOOD_AVAILABILITY (BBID, BG, QUANTITY) VALUES ('BB2', 'A+', '10');
INSERT INTO BLOOD_AVAILABILITY (BBID, BG, QUANTITY) VALUES ('BB3', 'B+', '17');
INSERT INTO BLOOD_AVAILABILITY (BBID, BG, QUANTITY) VALUES ('BB4', 'A+', '15');
INSERT INTO BLOOD_AVAILABILITY (BBID, BG, QUANTITY) VALUES ('BB2', 'O+', '13');
INSERT INTO BLOOD_AVAILABILITY (BBID, BG, QUANTITY) VALUES ('BB4', 'O+', '10');
INSERT INTO BLOOD_AVAILABILITY (BBID, BG, QUANTITY) VALUES ('BB1', 'AB+', '20');
INSERT INTO BLOOD_AVAILABILITY (BBID, BG, QUANTITY) VALUES ('BB3', 'O-', '5');
INSERT INTO BLOOD_AVAILABILITY (BBID, BG, QUANTITY) VALUES ('BB1', 'A-', '2');
INSERT INTO BLOOD_AVAILABILITY (BBID, BG, QUANTITY) VALUES ('BB2', 'B+', '25');
INSERT INTO BLOOD_AVAILABILITY (BBID, BG, QUANTITY) VALUES ('BB4', 'AB+', '7');
INSERT INTO BLOOD_AVAILABILITY (BBID, BG, QUANTITY) VALUES ('BB3', 'O+', '30');
INSERT INTO BLOOD_AVAILABILITY (BBID, BG, QUANTITY) VALUES ('BB2', 'B-', '1');
INSERT INTO BLOOD_AVAILABILITY (BBID, BG, QUANTITY) VALUES ('BB1', 'B+', '25');
INSERT INTO BLOOD_AVAILABILITY (BBID, BG, QUANTITY) VALUES ('BB2', 'AB+', '7');
INSERT INTO BLOOD_AVAILABILITY (BBID, BG, QUANTITY) VALUES ('BB4', 'B+', '15');
INSERT INTO BLOOD_AVAILABILITY (BBID, BG, QUANTITY) VALUES ('BB4', 'O-', '2');
INSERT INTO BLOOD_AVAILABILITY (BBID, BG, QUANTITY) VALUES ('BB1', 'AB+', '1');
INSERT INTO BLOOD_AVAILABILITY (BBID, BG, QUANTITY) VALUES ('BB1', 'A+', '10');
INSERT INTO BLOOD_AVAILABILITY (BBID, BG, QUANTITY) VALUES ('BB3', 'A+', '15');

select * from BLOOD_AVAILABILITY;


-- BUSINESS QUERIES --
-- Q1 Display Patient information along with hospital name from where they received blood
-- (PATIENT, BLOODBANK, and HOSPITAL.) --

SELECT PATIENT.PID, PATIENT.PNAME, HOSPITAL.HNAME
FROM PATIENT JOIN BLOODBANK
ON PATIENT.BBID = BLOODBANK.BBID
JOIN HOSPITAL
ON BLOODBANK.BBID = HOSPITAL.BBID;
 
-- Q2 Retrieve Hospitals with available blood types and quantities


SELECT HOSPITAL.HNAME, HOSPITAL.HID, BLOOD_AVAILABILITY.BG, BLOOD_AVAILABILITY.QUANTITY
FROM HOSPITAL LEFT JOIN BLOOD_AVAILABILITY
ON HOSPITAL.BBID = BLOOD_AVAILABILITY.BBID;
 
-- Q3 Display the blood bank details where O- blood is available

SELECT *
FROM BLOODBANK INNER JOIN BLOOD_AVAILABILITY
ON BLOODBANK.BBID = BLOOD_AVAILABILITY.BBID
WHERE BG IN ('O-');

-- Q4 Display the patient names who received blood through the reference of hospital 
-- and also print referenced hospital name with its id

SELECT PNAME, HNAME, HID
FROM PATIENT INNER JOIN HOSPITAL
ON PATIENT.PID = HOSPITAL.PID
WHERE PATIENT.PID IN (SELECT HOSPITAL.PID FROM HOSPITAL GROUP BY HOSPITAL.PID);

-- Q5 Display the patient name who received blood from different hospitals.

SELECT PNAME
FROM PATIENT
WHERE PID IN (SELECT PID 
				FROM HOSPITAL
					GROUP BY PID
                    HAVING COUNT(PID) > 1);
                    
-- Q6 Display the details of donor who cannot donate the blood

SELECT *
FROM DONAR
WHERE DATE_SUB(CURDATE(), INTERVAL 3 MONTH) >= DON_DATE;

